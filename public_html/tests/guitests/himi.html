<!DOCTYPE html>
<html>
  <head>
    <title>TODO supply a title</title>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel="stylesheet" href="../../lib/jQueryUI-1.11.4/jquery-ui.css" type="text/css"/>

    <style>
      * {font-family:Arial;color: black; font-size: 12px;}
      body{ margin: 20px 20px 20px 20px; }
      table, td { border: 1px solid lightgrey; border-collapse: collapse;padding: 5px 3px ;}
      textarea{ width:500px;}
      label { display: inline-block; vertical-align: baseline; width: 80px;  margin: 5px 2px; font-weight: bold}
      input { display: inline-block; vertical-align: baseline; width: 550px; margin: 5px 2px;}

      .textfield{ margin: 15px 1px 15px 1px; width:600px;}
      .ui-selectmenu-button {width:300px;}
      .ui-selectmenu-menu {height:250px; overflow:auto}

      #orderresponse { width:500px; }
      #himilist{ margin: 5px 1px 5px 1px; width:500px;  float:left;}
      #orderattr{ margin: 5px 10px 5px 10px; width:500px; float:left; }
      #himilist table td:nth-child(2) { width: 500px;}
      #dlgQas textarea{ width:450px;}
    </style>
    <script src='/lib/underscore-1.8.3/underscore-1.8.3.js'></script>
    <script src='/lib/jquery-1.11.3/jquery-1.11.3.js'></script>
    <script src='/lib/jQueryUI-1.11.4/jquery-ui.js'></script>
    <script src='/lib/numeric.js'></script>
    <script src='/numeric.js'></script>
    <script src="/js/himi.js"></script>
    <script>
      var
        himis,
        acthimirow,
        actqasrow,
        readonly = false;
      // ##########################################################################################################
      // Himitabelle
      // ##########################################################################################################
      var rendererHimi = {
        lfdnr: function (data, row, r) {
          return data;
        },
        item: function (data, row) {
          return data;
        },
        edit: function (data, row, r) {
          return "<span id='himi" + r + "' class='ui-icon ui-icon-pencil'></span>";
        },
        info: function (data, row, r) {
          return "<span id='himi" + r + "' class='ui-icon ui-icon-info'></span>";
        },
        del: function (data, row, r) {
          var isdigital = row[0];
          return isdigital ? "" : "<span id='himi" + r + "' class='ui-icon ui-icon-trash'></span>";
        }
      };

      var himilistopts_edit = {
        columns: [
          {name: "Digital", invisible: true},
          {render: rendererHimi.lfdnr},
          {render: rendererHimi.item},
          {render: rendererHimi.edit},
          {render: rendererHimi.del}
        ]
      };
      var himilistopts_readonly = {
        columns: [
          {name: "Digital", invisible: true},
          {render: rendererHimi.lfdnr},
          {render: rendererHimi.item},
          {render: rendererHimi.info}
        ]
      };

      var himilistopts = readonly ? himilistopts_readonly : himilistopts_edit

      // ##########################################################################################################
      // QAS-Tabelle
      // ##########################################################################################################
      var rendererQas = {
        motivation: function (data, row) {
          return data.substring(0, 500) + (data.length > 500 ? '...' : '');
        },
        edit: function (data, row, r) {
          return "<span id='qas" + r + "' class='ui-icon ui-icon-pencil'></span>";
        },
        info: function (data, row, r) {
          return "<span id='qas" + r + "' class='ui-icon ui-icon-info'></span>";
        },
        del: function (data, row, r) {
          var isdigital = row[0];
          return isdigital ? "" : "<span id='qas" + r + "' class='ui-icon ui-icon-trash'></span>";
        }
      };
      var qaslistopts_edit = {
        columns: [
          {name: "Digital", invisible: true},
          {name: "Frage"},
          {name: "Antwort"},
          {name: "Begründung", render: rendererQas.motivation},
          {name: '', render: rendererQas.edit},
          {name: '', render: rendererQas.del}
        ]
      };
      var qaslistopts_readonly =
        {columns: [
            {name: "Digital", invisible: true},
            {name: "Frage"},
            {name: "Antwort"},
            {name: "Begründung", render: rendererQas.motivation},
            {name: '', render: rendererQas.info}
          ]
        };
      var qaslistopts = readonly ? qaslistopts_readonly : qaslistopts_edit;

      // ##########################################################################################################

      function initHimiTable(himis) {
        var himidata = _.map(himis, function (h) {
          return [h.digital, h['lfd-nr'], h.number + ' ' + h.text];
        });
        $('#grid').himitable(himilistopts, himidata);
        initActionsForHimilist();
        if( himis.length>=3  )  // max. 10 HiMis
          $('#addHimi .ui-icon-circle-plus').hide();
        else  
          $('#addHimi.ui-icon-circle-plus').show()
      }

      function initQasTable(qas) {
        var qasdata = _.map(qas, function (qa) {
          return [qa.digital, qa['question-text'], qa['answer-text'], qa['motivation']];
        });
        $('#qastable').himitable(qaslistopts, qasdata);
        initActionsForQaslist(qas);
        if( qas.length>=3 )  // max. 14 Qas
          $('#addQas .ui-icon-circle-plus').hide();
        else  
          $('#addQas.ui-icon-circle-plus').show()

      }

      // ##########################################################################################################

      function initActionsForHimilist() { // Actions for Himilist
        $('#himilist .ui-icon-trash').off().on('click', function (ev) { // delete himi
          var r = parseInt(ev.target.id.replace('himi', ''));
          himis.splice(r, 1);
          initHimiTable(himis);
        });
        $('#himilist .ui-icon-pencil, #himilist .ui-icon-info').off().on('click', function (ev) { // edit himi
          var r = parseInt(ev.target.id.replace('himi', ''));
          $('#dlgHimi').dialog('option', 'title', 'Hilfsmittel ' + himis[r].text).dialog('open');
          $('#dlgHimi input#himinumber').val(himis[r].number);
          $('#dlgHimi input#himiname').val(himis[r].text);
          initQasTable(himis[r].qas);
          acthimirow = r;
        });
        $('#himilist #addHimi').off().on('click', function () { // add himi
          var nhimi = himiutils.createHimi('', '');
          nhimi.isnew = true;
          himis.push(nhimi);
          //$('#dlgHimi .himitable').remove();
          $('#dlgHimi').dialog('option', 'title', 'Neues Hilfsmittel').dialog('open');
          $('#dlgHimi input#himinumber').val('');
          $('#dlgHimi input#himiname').val('');
          var r = himis.length - 1;
          initQasTable(himis[r].qas);
          acthimirow = r;
        });
      }

      function initActionsForQaslist(qas) {   // Actions for Qaslist
        $('#qastable .ui-icon-trash').off().on('click', function (ev) { // delete qas
          var r = parseInt(ev.target.id.replace('qas', ''));
          var qas = himis[acthimirow].qas;
          qas.splice(r, 1);
          initQasTable(qas);
        });
        $('#qastable .ui-icon-pencil, #qastable .ui-icon-info').off().on('click', function (ev) { // edit qas
          var r = parseInt(ev.target.id.replace('qas', ''));
          var actqas = qas[r];
          actqasrow = r;
          $('#quests').html(himiutils.selectBox('quests', quests));
          $('#answs').html(himiutils.selectBox('answs', answs));
          $('#quests option[val=' + actqas['question-number'] + ']').attr('selected', true);
          $('#answs  option[val=' + actqas['answer-number'] + ']').attr('selected', true);

          $('#dlgQas .selectmenu').selectmenu();
          //$('#dlgQas select#quests').selectmenu().selectmenu(actqas.digital ? 'disable' : 'enable');
          $('#dlgQas select#quests option:not(:selected)').attr('disabled', actqas.digital);

          $('#dlgQas .ui-selectmenu-button').width(450);
          $('#dlgQas textarea').val(actqas['motivation']);
          if (readonly) {
            $('option:not(:selected)').attr('disabled', true);
          }
          $('#dlgQas').dialog('option', 'title', 'Frage ' + (r + 1)).dialog('open');
        });
        $('#addQas').off().on('click', function () {  // add qas
          var nqa = himiutils.createQas(-1, $('#dlgQas #reason').val(), quests[0], answs[0]);
          nqa.isnew = true;
          himis[acthimirow].qas.push(nqa);
          $('#quests').html(himiutils.selectBox('quests', quests));
          $('#answs').html(himiutils.selectBox('answs', answs));
          $('#dlgQas .selectmenu').selectmenu();
          $('#dlgQas .ui-selectmenu-button').width(450);
          $('#dlgQas textarea').val('');
          $('#dlgQas').dialog('option', 'title', 'Neue Frage').dialog('open');
          actqasrow = himis[acthimirow].qas.length - 1;
        });
      }

      function initDialog(data) {
        initHimiTable(data.himis);

        // Select Auftrags-Antwort
        $('#answers').html(himiutils.selectBox('orderresponse', answs));
        $('#orderresponse option[val=' + data['global-answer-id'] + ']').attr('selected', true);
        $('#orderresponse').selectmenu({
          change: function (event, ui) {
            data['global-answer-id'] = ui.item.index;
          }
        });

        // Textareas
        $('#medical-base').val(data['medical-base']);
        $('#anamnesis').val(data['anamnesis']);
        $('#indication').val(data['indication']);
        $('#evaluation').val(data['evaluation']);
        $('#suggestion').val(data['suggestion']);
        $('#medical-base,#anamnesis,#indication,#evaluation,#suggestion').on("change", function (ev) {
          console.log('change', ev.target.id, $('#' + ev.target.id).val());
          data[ev.target.id] = $('#' + ev.target.id).val();
        });

        // HIMI-Dialog
        $('#dlgHimi').dialog({title: 'Hilfsmittel', autoOpen: false, height: 500, width: 700,
          close: function (event, ui) {
            himis = _.reject(himis, {isnew: true});
          },
          buttons: {
            Ok: function () {
              himis[acthimirow].text = $('#dlgHimi input#himiname').val();
              himis[acthimirow].number = $('#dlgHimi input#himinumber').val();
              delete himis[acthimirow].isnew;
              initHimiTable(himis);
              $(this).dialog("close");
            },
            Abbrechen: function () {
              $(this).dialog("close");
            }
          }
        });

        // Qas-Dialog
        $('#dlgQas').dialog({title: 'Frage', autoOpen: false, height: 300, width: 500,
          close: function (event, ui) {
            himis[acthimirow].qas = _.reject(himis[acthimirow].qas, {isnew: true});
          },
          buttons: {
            Ok: function () {
              himis[acthimirow].qas[actqasrow].motivation = $('#dlgQas #reason').val();
              _.extend(himis[acthimirow].qas[actqasrow],
                _.findWhere(quests, {'question-number': $('#dlgQas select#quests option:selected').attr('val')}),
                _.findWhere(answs, {'answer-number': $('#dlgQas select#answs  option:selected').attr('val')})
                );
              delete himis[acthimirow].qas[actqasrow].isnew;
              initQasTable(himis[acthimirow].qas);
              $(this).dialog("close");
            },
            Abbrechen: function () {
              $(this).dialog("close");
            }
          }
        });

        if (readonly) {
          $("textarea, input").prop('disabled', true);
          $('option:not(:selected)').attr('disabled', true);
          $('.ui-icon-circle-plus').hide();
        }
      }

      $(document).ready(function () {
        $(".positive-integer").numeric({decimal: false, negative: false}, function () {
          alert("Nur Ziffern erlaubt!");
          this.value = "";
          this.focus();
        });
        $('textarea[maxlength]').bind("keyup change",function () {
          var maxlen = $(this).attr('maxlength');
          if ($(this).val().length > maxlen) {
            $(this).val($(this).val().substr(0, maxlen));
          }
        });
        $.ajax({
          url: "/data/himidata.js",
          success: function () {
            himis = result.data.himis;
            initDialog(result.data);
          }
        });
      });

    </script>
  </head>
  <body>

    <div id='himilist'>
      <h1>Hilfsmittel:</h1>
      <div id='grid'></div>
      <span id='addHimi' class='ui-icon ui-icon-circle-plus'></span>
      <br>
    </div>

    <div id='orderattr'>
      <h1>Auftrags-Antwort:</h1>
      <div id='answers'></div>
      <div class='textfield'><h1>Medizinische Unterlagen:  </h1><textarea id='medical-base' rows='4' cols='80' maxlength='100'></textarea></div>
      <div class='textfield'><h1>Anamnese:                 </h1><textarea id='anamnesis'    rows='4' cols='80' maxlength='100'></textarea></div>
      <div class='textfield'><h1>Befund:                   </h1><textarea id='indication'   rows='4' cols='80' maxlength='100'></textarea></div>
      <div class='textfield'><h1>Antwort mit Begründung:   </h1><textarea id='evaluation'   rows='4' cols='80' maxlength='100'></textarea></div>
      <div class='textfield'><h1>Empfehlung:               </h1><textarea id='suggestion'   rows='4' cols='80' maxlength='100'></textarea></div>
    </div>

    <div id='dlgHimi'>
      <label for="himinumber">Nummer:</label><input id='himinumber' class="positive-integer" type='text'/><br/>
      <label for="himiname">Bezeichnung: </label><input id='himiname' type='text'/>
      <h1>Fragen:</h1>
      <div id="qastable"></div>
      <span id='addQas' class='ui-icon ui-icon-circle-plus'></span>
    </div>

    <div id='dlgQas'>
      <div id='quests'></div>
      <div id='answs'></div>
      <h1>Begründung:</h1>
      <textarea id="reason" rows=5 cols=80 maxlength='100'></textarea>
    </div>

  </body>
</html>
