<!DOCTYPE html>
<html>
  <head>
    <title>Beispiel 4 Nur ein TEST</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />

    <link rel="stylesheet" href="/vendor/jQueryUI-1.12.0/jquery-ui.css">
    <link rel="stylesheet" href="/css/ebtable.css">
    <style>
      * {font-family:Arial; color: black; font-size: 10px;}
      body { width: 1000px; }
    </style>

    <script src="/vendor/underscore-1.8.3/underscore.js"></script>
    <script src="/vendor/jQuery-1.11.3/jquery.js"></script>
    <script src="/vendor/jQueryUI-1.12.0/jquery-ui.js"></script>
    <script src="/js/eblib/mx.js"></script>
    <script src="/js/eblib/ebtable.js"></script>
    <!--<script src="/data/ebTableGroupExternalSmall.js"></script>-->
    <script src="/data/ebTableTestDataKhbasketSmall.js"></script>
    <script src="/data/ebTableTestDataKhbasketLarge.js"></script>

    <script>
      'use strict';

      var flagsdef = [
        {key: '!', id: 1, img: 'important.gif', alt: 'Eilauftrag'},
        {key: '*', id: 2, img: 'blackstar.gif', alt: 'Spezialfall'},
        {key: 'P', id: 4, img: 'problem.gif', alt: 'Problemfall'},
        {key: 'F', id: 8, img: 'caseConsolidation.gif', alt: 'Fallzusammenführung'},
        {key: 'G', id: 16, img: 'isPrg.gif', alt: 'Prg'},
        {key: 'K', id: 32, img: 'korrekturauftrag.gif', alt: 'Korrekturauftrag'},
        {key: 'S', id: 64, img: 'sperre.gif', alt: 'Sperre'},
        {key: 'C', id: 128, img: 'storniert.gif', alt: 'Stornierung angefordert'}
      ];
      var flags = _.pluck(flagsdef, 'key').join('');

      var flagutils = {
        fromBitNumber: function (bits) { // 5 (101)  -->  '!P' # 7 (111) -> '!*p' # 8 (1000) -> F
          return _.reduce(Number(bits).toString(2).split('').reverse(), function (acc, o, i) {
            return acc += (o === '1' && flags[i] ? flags[i] : '');
          }, '');
        },
        toBitNumber: function (str) { // '!P' -> 5 (101), '!PG' -> 21
          return _.reduce(str.toUpperCase().split(''), function (acc, c) {
            var x = _.findWhere(flagsdef, {key: c});
            return acc += x ? x.id : 0;
          }, 0);
        }
      };

      var matcher = {
        paketname: function (cellData, searchtxt, row, tbldata) {
          var rexp = new RegExp('^' + searchtxt.replace(/\*/g, '.*'), 'i');
          var cid = row[idx.gid] > 0 ? row[idx.gid] : null; // chargeid
          var cname = cid ? tbldata.groupsdata[cid].groupname : ''; // chargename
          return cname.match(rexp);
        },
        auftrag: function (cellData, searchtxt, row) {
          var rexp = new RegExp('^' + searchtxt.replace(/\*/g, '.*'), 'i');
          if (row[idx.gtyp] === 'C')
            return cellData.match(rexp);
          if (row[idx.gtyp] === 'W' && row[idx.gid] < 0)
            return cellData.match(rexp);
          if (row[idx.gtyp] === 'W' && row[idx.gid] >= 0)
            return row[idx.gss].match(rexp);
        },
        flags: function (cellData, searchtxt) {
          return !(flagutils.toBitNumber(searchtxt) & ~cellData);
        },
        dta: function (cellData, searchtxt) {
          return _.every(searchtxt.split(','), function (v) {
            return cellData.contains(v);
          });
        },
        besonderheit: function (cellData, searchtxt) {
          return _.every(searchtxt.split(','), function (v) {
            return cellData.match(new RegExp(v.replace(/\*/g, '.*'), 'i'));
          });
        }
      };

      var renderer = {
        paketname: function (data, row, r, tbldata) {
          var cid = row[idx.gid] > 0 ? row[idx.gid] : null; // chargeid
          return cid ? tbldata.groupsdata[cid].groupname : '';
          //return data.substring(0,30).replace(/ /g, '\u00a0') + data.substring(30); // a0 = &nbsp; -> prevent line wrap in table cell if data.length <30
        },
        auftrag: function (data, row, type) {
          var sessionId = '<%=session.getId()%>';
          var chargeId = row[idx.gid];
          var name = data.substring(0, 30).replace(/ /g, '\u00a0') + data.substring(30);
          if (row[idx.gtyp] !== 'C') {
            var t = _.template(
              '<input name="name_<\%=wid%>" value="<\%=workorderName%>" hidden="true"/>\
                   <a href="/ISmed/showOrder.do;jsessionid=<\%=sid%>?src=khbasket2&workorderid=<\%=wid%>" title="<\%=wid%>"><\%=workorderName%></a>');
            return t({chd: data, wid: row[idx.wnm], workorderName: name, sid: sessionId});
          }

          var isOpen = grid ? grid.groupIsOpen(chargeId) : false;
          var imgsrc = isOpen ? '/images/details_opened.png' : '/images/details_closed.png';
          var auftrag = row[idx.gcnt] === 1 ? 'Auftrag' : 'Aufträge';
          var t = '\
                   <img src="<\%=imgsrc%>" onclick="grid.toggleGroupIsOpen(\'<\%=chargeId%>\')"/>\
                      <b>&nbsp;<\%=chargeName%></b>&nbsp;(<\%=cnt%>&nbsp;<\%=auftrag%>)';
          return _.template(t)({imgsrc: imgsrc, chargeId: chargeId, chargeName: name, cnt: row[1], auftrag: auftrag});
        },
        flags: function (data, row, type) {
          //return flagutils.fromBitNumber(data);
          return _.reduce(flagsdef, function (acc, o) {
            return acc += (data & o.id) ? _.template("<img src='/images/<\%=img%>' alt='<\%=alt%>' title='<\%=alt%>' height='10px'/>")({img: o.img, alt: o.alt}) : '';
          }, '');
        },
        frist: function (data, row, type) {
          //var chargeId = _.isNumber(row[2]) ? row[2].toString() : row[2];
          //var g = grid.getGroup(chargeId);
          //var frist = g ? g.fristmin : data;
//               if ( type === 'filter') {// || type === 'display') {
//                  return sprintf("%+05d#%+08s", frist, data);
//               }
          return data; // sprintf("%+05d#%+08d", frist, data);// data;
        },
        dta: function (data, row) {
          return data.replace(/,/g, ', ');
        },
        select: function (origData, row, type) {
          var ret = '';
          var cid = row[2] > 0 ? row[2] : null; // chargeid
          var wid = row[idx.wid]; // workorderid
          var cty = row[idx.cty]; // chargeType
          if (row[0] === 'C') {
            var chargename = row[idx.wnm];
            var g = origData.groupsdata[cid];
            var wids = g.wids.join(',');
            var pids = g.pids.join(',');
            var pers = g.pers.join(',');
            var spc = g.spc + '';
            var t = _.template("\
                   <input \
                     title='charge_<\%=wids%>'\
                     type='checkbox'\
                     id='cb_<\%=cid%>' \
                     name='cb_<\%=name%>' \
                     value='<\%=cid%>'\
                     specialcase='<\%=spc%>'\
                     onclick=\"selectCharge('<\%=cid%>', '<\%=wids%>', '<\%=pids%>', '<\%=pers%>','<\%=spc%>', '<\%=cty%>' );\"\
                 />");
            ret = t({name: chargename, cid: cid, wids: wids, pids: pids, pers: pers, spc: spc, cty: cty});
          } else {
            var pid = row[idx.pid]; // processstatusid
            var per = row[idx.per]; // performer
            var spc = row[idx.flg] & 2; // specialcase (from flags)
            var t = _.template("\
                   <input \
                     type=checkbox\
                     id='cb_<\%=wid%>'\
                     name='cb_<\%=wid%>'\
                     value='<\%=wid%>'\
                     specialcase='<\%=spc%>'\
                     onclick=\"selectOrder('<\%=wid%>','<\%=wid%>_<\%=pid%>','<\%=wid%>_<\%=per%>',null,'<\%=spc%>',null);\"\
                   />");
            ret = t({wid: wid, pid: pid, per: per, cid: cid, spc: spc, cty: cty});
          }
          return ret;
        },
        selectAll: function () {
          return "\
            <input \
              type=checkbox\
              id='select_all'\
              name='select_all'\
              onclick=\"select_all();\"\
            />";
        }
      };

      $.extend($.fn.ebtable.sortformats, {
        'flags': function fmtflags(v, row, groups) {
          return  row[idx.gid] < 0 ? flagutils.fromBitNumber(v) : flagutils.fromBitNumber(groups[row[idx.gid]].flg);
        }
      });

      var idx = {gtyp: 0, gcnt: 1, gid: 2, gss: 3, wid: 4, pid: 5, per: 6, cty: 7, flg: 8, frs: 9, wnm: 12};

      function preprocessData(data) {
        // 0                      1     2        3             4                  5         6          7        8      9                    10       11               12
        // charge                 #  chargeid  xxx  workorderid     ProcessStatusId Performer chargeType (X)flags  frist                status   kürzel   Auftrag/Charge 
        // ["C",                  3, 7971,        , 50000005209,                  ,         ,      'DIS',       4,    '',     "Zur Disposition",     '', "AAAA", ... ]
        // ["W",                  1, 7971,        , 50000005209,                  ,         ,      'BGL',       0, -1247, "Zur Sachbearbeitung",     '', "Schwarz..", ...]
        // ...
        var groupsdata = {};
        for (var r = 0; r < data.length; r++) {
          var row = data[r];
          row.splice(idx.gss, 0, 'SORTCOL!!!'); // create empty column for storing grouping info (gss)
          row.splice(idx.wnm + 1, 0, '');
          var chargeId = row[idx.gid];
          if (chargeId < 0)
            continue;
          var wid = row[idx.wid];
          var chargeName = row[idx.wnm];
          if (row[idx.gtyp] === 'C') {
            groupsdata[chargeId] = {
              groupname: chargeName,
              isOpen: false,
              isSelected: false,
              fristmin: row[idx.frs],
              fristmax: row[idx.frs],
              wids: [], // Liste der zur Gruppe gehörenden workorderids: [50000004850,50000005018,50000005204]
              pids: [], // Liste ProcessStatusIds: [50000004850_524288,50000005018_524288,50000005204_1048576]
              pers: [], // Liste preformers: 50000004850_50000000000015,50000005018_50000000000015,50000005204_50000000000015
              spc: false, //  Mindestens ein Auftrag in der Charge ist 'special'
              flg: row[idx.flg]
            };
          } else if (row[idx.gtyp] === 'W' && chargeId >= 0 && groupsdata[chargeId]) {
            var g = groupsdata[chargeId];
            g.fristmin = row[idx.frs] < g.fristmin ? row[idx.frs] : g.fristmin;
            g.fristmax = row[idx.frs] > g.fristmax ? row[idx.frs] : g.fristmax;
            g.wids.push(wid);
            g.pids.push(wid + '_' + row[idx.pid]);
            g.pers.push(wid + '_' + row[idx.per]);
            g.spc = g.spc || (row[idx.flg] & 2);
          }
        }
        console.log('Grouping', groupsdata);
        data.groupsdata = groupsdata;
      }

      var grid;

      var opts = {
        bodyHeight: 750,
        flags: {
          clearFilter: true,
          colsResizable: true,
        },
        columns: [
          {name: "Grouping", technical: true, invisible: true, sortorder: 'asc-fix'},
          {name: "GroupCnt", technical: true, invisible: true},
          {name: "GroupIds", technical: true, invisible: true},
          {name: "GroupSort", technical: true, invisible: true},
          {name: "WorkorderId", technical: true, invisible: true},
          {name: "StatusId", technical: true, invisible: true},
          {name: "Performer", technical: true, invisible: true},
          {name: "ChargeType", technical: true, invisible: true},
          {name: "Flags", mandatory: true, render: renderer.flags, match: matcher.flags, sortmaster: [{col: idx.flg, sortformat: 'flags'}, {col: idx.gid}, {col: idx.gtyp}], tooltip: 'Mögliche Werte: !*pfgksc'},
          {name: "Frist", mandatory: true, render: renderer.frist},
          {name: "Status", mandatory: true},
          {name: "Kürzel", mandatory: true},
          {name: "Auftrag", mandatory: true, render: renderer.auftrag, match: matcher.auftrag, sortmaster: [{col: idx.gss}, {col: idx.gtyp}]},
          {name: "Paketname", render: renderer.paketname, match: matcher.paketname, sortmaster: [{col: idx.gss}, {col: idx.gtyp}]},
          {name: "Krankenhaus"},
          {name: "Abteilung"},
          {name: "Fachlichkeit"},
          {name: "Besonderheit", match: matcher.besonderheit},
          {name: "Krankenkasse"},
          {name: "Einlieferung", sortformat: 'date-de'},
          {name: "Entlassung", sortformat: 'date-de'},
          {name: "DRG"},
          {name: "GArt"},
          {name: "Produkt"},
          {name: "FAG"},
          {name: "DTANummern", render: renderer.dta, match: matcher.dta},
          {name: "Vorg.VGA"},
          {name: "KHFrist"},
        ],
        selectionCol: true,
        sortmaster: [{col: 2}, {col: 0}], //[{col:1, sortorder:'asc', sortformat:'date-de'},{col:2, sortorder:'desc'}]
        groupdefs: {grouplabel: 0, groupcnt: 1, groupid: 2, groupsortstring: 3, groupname: idx.wnm, grouphead: 'C', groupelem: 'W'}

      };

      $().ready(function () {
        preprocessData(basketTestdataKH);
        grid = $('#grid').ebtable(opts, basketTestdataKH);
      });
    </script>
  </head>
  <body>
    <div id="grid"></div>
  </body>
</html>
