<!DOCTYPE html>
<html>
   <head>
      <title>Beispiel 1</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="/lib/jQueryUI-1.11.4/jquery-ui.css">
      <style>
         * {
            font-family:Arial;
            color: black;
            font-size: 10px;
         }
      </style>
      <link rel="stylesheet" href="/css/ebtable.css">

      <script src="/lib/underscore-1.8.3/underscore-1.8.3.js"></script>
      <script src="/lib/jquery-1.11.3/jquery-1.11.3.js"></script>
      <script src="/lib/jQueryUI-1.11.4/jquery-ui.js"></script>
      <script src="/js/mx.js"></script>
      <script src="/js/ebtable.js"></script>
      <script>
         'use strict';
         var basketTestdata = [
            ['  ', 1, -1, 'Wolperdinger', '31.08.1915', 'Herder, Johann Gottfried', 5],
            ['  ', 1, -1, 'Yeti        ', '31.08.2016', 'Lichtenberg, Georg Christoph ', 31],
            ['GA', 5, 10, 'Säugetiere  ', '', '', 0],
            ['GB', 1, 10, 'Esel        ', '05.08.2011', 'Liebig, Ellen,', 1],
            ['GB', 1, 10, 'Affe        ', '10.06.2013', 'Heine, Heinrich', 2],
            ['GB', 1, 10, 'Maus        ', '15.09.2014', 'Manne, Antonia', 4],
            ['GB', 1, 10, 'Hase        ', '15.09.2014', 'Liebig, Gustav', 8],
            ['GB', 1, 10, 'Hund        ', '31.08.2015', 'Mann, Heinrich Gustav Friedhelm', 16],
            ['GA', 4, 20, 'Insekten    ', '', '', 0],
            ['GB', 1, 20, 'Fliege      ', '31.08.2009', 'Mann, Thomas', 0],
            ['GB', 1, 20, 'Biene       ', '31.08.2001', 'Lessing, Gottfried', 7],
            ['GB', 1, 20, 'Hummel      ', '01.08.1759', 'Schiller, Friedrich', 0],
            ['GB', 1, 20, 'Wespe       ', '31.06.1900', 'Storm, Theodor', 0],
            ['GA', 2, 30, 'Fische      ', '', '', 0],
            ['GB', 1, 30, 'Karpfen     ', '31.08.2009', 'Mann, Thomas', 0],
            ['GB', 1, 30, 'Forelle     ', '31.08.2001', 'Lessing, Gottfried', 7],
            ['  ', 1, -1, 'Einhorn     ', '04.11.2017', 'Goethe, Johann Wolfgang', 63],
            ['  ', 1, -1, 'Lindwurm    ', '31.12.2018', 'Schiller, Friedrich', 255]
         ];
         for (var i = 0; i < basketTestdata.length; i++) {
            basketTestdata[i].splice(3, 0, 'XXX');
         }
         //console.log( basketTestdata );

         //#######################################################################

         $.extend($.fn.ebtable.sortformats, {
            'flags': function (data) { // 5 (101)  -->  '!P' | 7 (111) -> '!*P'
               var flgs = '!*pfgksc';
               var s = '';
               for (var i = 0, j = 1; i < flgs.length; i++, j *= 2) {
                  s += (data & j) ? flgs[i] : '';
               }
               return s;
            },
            'withgroup': function (data, row, groups) {
               var groupId = row[2] > 0 ? row[2] : 0;
               var g = groupId ? groups[groupId] : null;
               return g ? g['name'] + row[0] + data : data;
            }
         });

         var renderer = {
            renderTierart: function (data, row, type) {
               var groupid = row[2];
               if (groupid < 0)
                  return data;

               var isOpen = grid ? grid.groupIsOpen(groupid) : false;
               var imgsrc = '/images/details_' + (isOpen ? 'opened' : 'closed') + '.png';
               var link = '<img src="' + imgsrc + '" onclick="grid.toggleGroupIsOpen(\'' + groupid + '\')" /><b>&nbsp;' + data + '</b>';
               return row[0] === 'GA' ? link : data;
            },
            renderFlags: function (data, row, type) {
               if (type === 'filter') {// || type === 'display') 
                  return grid.sortformats.flags(data);
               }
               var imgmap = [
                  {key: '!', id: 1, img: 'important.gif', alt: 'Eilauftrag'},
                  {key: '*', id: 2, img: 'blackstar.gif', alt: 'Spezialfall'},
                  {key: 'P', id: 4, img: 'problem.gif', alt: 'Problemfall'},
               ];
               var s = '';
               for (var i = 0; i < imgmap.length; i++) {
                  var o = imgmap[i];
                  s += (data & o.id) ? "<img src='/images/" + o.img + "' alt='" + o.alt + "' title='" + o.alt + "' />" : "";
               }
               return s;
            },
            renderSelect: function (data, row, type) {
               if (row[0] === 'GA') {
                  return '<input type="checkbox"/>';
               } else {
                  return '<input type="checkbox"/>';
               }
            }
         };

         var opts = {
            columns: [
               {name: "Grouping", invisible: true, technical: true, order: 'asc-fix'},
               {name: "GroupCnt", invisible: true, technical: true},
               {name: "GroupIds", invisible: true, technical: true},
               {name: "GroupSort", invisible: true, technical: true},
               {name: "Tierart", render: renderer.renderTierart, sortformat: 'withgroup', nosortmaster: true},
               {name: "Datum", sortformat: 'date-de'},
               {name: "Welcher Name"},
               {name: "Flag", render: renderer.renderFlags, sortformat: 'flags', tooltip: 'Mögliche Werte:!*pfgksc'}
            ],
            selection: {render: renderer.renderSelect},
            sortmaster: [{col: 2}, {col: 0}], //[{col:1,order:'asc',sortType:'date-de'},{col:2,order:'desc'}]
            groupingCols: {groupsort: 0, groupcnt: 1, groupid: 2, groupsortstring: 3, groupname: 4, grouphead: 'GA', groupelem: 'GB'},
            sortcolname: 'Tierart'
         };
         var grid;
         $().ready(function () {
            grid = $('#grid').ebtable(opts, basketTestdata);
         });
      </script>
   </head>
   <body>
      <div id="grid"></div>
   </body>
</html>
