<!DOCTYPE html>
<html>
   <head>
      <title>Beispiel 4 Nur ein TEST</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />

      <link rel="stylesheet" href="/lib/jQueryUI-1.11.4/jquery-ui.css">
      <link rel="stylesheet" href="/css/ebtable.css">
      <style>
         * {
            font-family:Arial;
            color: black;
            font-size: 10px;
         }
      </style>

      <script src="/lib/underscore-1.8.3/underscore-1.8.3.js"></script>
      <script src="/lib/jquery-1.11.3/jquery-1.11.3.js"></script>
      <script src="/lib/jQueryUI-1.11.4/jquery-ui.js"></script>
      <script src="/js/mx.js"></script>
      <script src="/js/ebtable.js"></script>
      <script src="/data/ebTableTestDataKhbasket.js"></script>

      <script>
         'use strict';
         var grid;
         var renderer = {
            renderAuftrag: function (data, row) {
               var chargeId = row[2];
               if (chargeId < 0)
                  return row[11] + data;
               var isOpen = grid ? grid.groupIsOpen(chargeId) : false;
               var imgsrc = !isOpen ? '/images/group_opened.png' : '/images/group_closed.png';
               var t = '\
                  <img src="<%=imgsrc%>" onclick="grid.toggleGroupIsOpen(\'<%=chargeId%>\')" />\n\
                  <b>&nbsp;<%=chargeName%>&nbsp;</b>\
                  (<%=cnt%> Aufträge)';
               var link = _.template(t)({imgsrc: imgsrc, chargeId: chargeId, chargeName: row[11], cnt: row[1]});
               return row[0] === 'C' ? link : data;
            },
            renderFlags: function (data, row, type) {
               if (type === 'filter') {// || type === 'display') 
                  return grid.sortformats.flags(data);
               }
               var imgmap = [
                  {key: '!', id: 1, img: 'important.gif', alt: 'Eilauftrag'},
                  {key: '*', id: 2, img: 'blackstar.gif', alt: 'Spezialfall'},
                  {key: 'P', id: 4, img: 'problem.gif', alt: 'Problemfall'},
                  {key: 'F', id: 8, img: 'caseConsolidation.gif', alt: 'Fallzusammenführung'},
                  {key: 'G', id: 16, img: 'isPrg.gif', alt: 'Prg'},
                  {key: 'K', id: 32, img: 'korrekturauftrag.gif', alt: 'Korrekturauftrag'},
                  {key: 'S', id: 64, img: 'sperre.gif', alt: 'Sperre'},
                  {key: 'C', id: 128, img: 'storniert.gif', alt: 'Stornierung angefordert'}
               ];
               var s = '';
               for (var i = 0; i < imgmap.length; i++) {
                  var o = imgmap[i];
                  if (data & o.id)
                     s += "<img src='/images/" + o.img + "' alt='" + o.alt + "' title='" + o.alt + "' />";
               }
               return s;
            },
            renderFrist: function (data, row, type) {
               //var chargeId = _.isNumber(row[2]) ? row[2].toString() : row[2];
               //var g = grid.getGroup(chargeId);
               //var frist = g ? g.fristmin : data;
//               if ( type === 'filter') {// || type === 'display') {
//                  return sprintf("%+05d#%+08s", frist, data);
//               }
               return data;// sprintf("%+05d#%+08d", frist, data);// data;
            },
            renderDTA: function (data, row) {
               return data.replace(/,/g, ', ');
            },
            renderSelect: function (origData, row, type) {
               var ret = '';
               var cid = row[2] > 0 ? row[2] : null; // chargeid
               var wid = row[3]; // workorderid
               var cty = ''; // ???row[7]; // chargeType
               if (row[0] === 'C') {
                  var chargename = row[10];
                  var g = origData.groups[cid];
                  var wids = g.wids.join(',');
                  var pids = g.pids.join(',');
                  var pers = g.pers.join(',');
                  var spc = g.spc + '';
                  var t = _.template("\
                     <input title='charge_<\%=wids%>'\
                       type='checkbox'\
                       id='cb_<\%=cid%>' \
                       name='cb_<\%=name%>' \
                       onclick=\"selectCharge('<\%=cid%>', '<\%=wids%>', '<\%=pids%>', '<\%=pers%>','<\%=spc%>', '<\%=cty%>' );\"\
                       value='<\%=cid%>'\
                       specialcase='<\%=spc%>'\
                   />");
                  ret = t({name: chargename, cid: cid, wids: wids, pids: pids, pers: pers, spc: spc, cty: cty});
               } else {
                  var pid = row[4]; // processstatusid
                  var per = row[5]; // performer
                  var spc = row[6] & 2; // specialcase (from flags)
                  var t = _.template("\
                     <input type=checkbox\
                       id='cb_<\%=wid%>'\
                       name='cb_<\%=wid%>'\
                       specialcase='<\%=spc%>'\
                       value='<\%=wid%>'\
                       onclick=\"selectOrder('<\%=wid%>','<\%=wid%>_<\%=pid%>','<\%=wid%>_<\%=per%>',null,'<\%=spc%>',null);\"\
                     />");
                  ret = t({wid: wid, pid: pid, per: per, cid: cid, spc: spc, cty: cty});
               }
               return ret;
            }
         };

         var opts = {
            columns: [
               {name: "Grouping", technical: true, invisible: true, order: 'asc-fix'},
               {name: "GroupCount", technical: true, invisible: true},
               {name: "GroupId", technical: true, invisible: true},
               {name: "WorkorderId", technical: true, invisible: true},
               {name: "StatusId", technical: true, invisible: true},
               {name: "Performer", technical: true, invisible: true},
               {name: "ChargeType", technical: true, invisible: true},
               {name: "Flags", render: renderer.renderFlags, sortformat: 'flags', tooltip: 'Mögliche Werte:!*PFGKSC'},
               {name: "Frist", render: renderer.renderFrist},
               {name: "Status"},
               {name: "Kürzel"},
               {name: "Auftrag", render: renderer.renderAuftrag},
               {name: "Krankenhaus"},
               {name: "Abteilung"},
               {name: "Fachlichkeit"},
               {name: "Besonderheit"},
               {name: "Krankenkasse"},
               {name: "Einlieferung", sortformat: 'date-de'},
               {name: "Entlassung", sortformat: 'date-de'},
               {name: "DRG"},
               {name: "GArt"},
               {name: "Produkt"},
               {name: "FAG"},
               {name: "DTANummern", render: renderer.renderDTA},
               {name: "Vorg.VGA"},
               {name: "KHFrist"}
            ],
            selection: {render: renderer.renderSelect},
            sortmaster: [{col: 11}, {col: 2}, {col: 0}], //[{col:1,order:'asc',sortType:'date-de'},{col:2,order:'desc'}]
            groupingCols: {groupid: 2, groupsort: 0, grouphead: 'C', groupname:11}
         };

         function preprocessData(data) {
            // 0                      1     2                3                4         5          6        7      8             9           10                              11
            // charge                 #  chargeid  workorderid  ProcessStatusId Performer chargeType (X)flags  frist
            // ["C",                  3, 7971,     50000005209,               ,         ,      'DIS',       4,    '', "problemtest",         ... ]
            // ["W",                  1, 7971,     50000005209,               ,         ,      'BGL',       0, -1247, "Zur Sachbearbeitung", '', "Schwarzz, Stephan, 12.12.1980", ...]
            // ... 
            var groups = {};
            for (var r = 0; r < data.length; r++) {
               var row = data[r];
               var chargeId = row[2];
               if (chargeId < 0)
                  continue;
               var wid = row[3];
               var chargeName = row[11];
               if (row[0] === 'C') {
                  groups[chargeId] = {
                     groupname: chargeName, isOpen: false, isSelected: false,
                     fristmin: row[8], fristmax: row[8],
                     wids: [], // Liste der zur Gruppe gehörenden workorderids: [50000004850,50000005018,50000005204]
                     pids: [], // Liste ProcessStatusIds: [50000004850_524288,50000005018_524288,50000005204_1048576]
                     pers: [], // Liste preformers: 50000004850_50000000000015,50000005018_50000000000015,50000005204_50000000000015
                     spc: 0   //  Mindestens ein Auftrag in der Charge ist 'special'
                  };
               } else if (row[0] === 'W' && chargeId >= 0) {
                  var g = groups[chargeId];
                  if (row[8] < g.fristmin)
                     g.fristmin = row[8];
                  if (row[8] > g.fristmax)
                     g.fristmax = row[8];
                  g.wids.push(wid);
                  g.pids.push(wid + '_' + row[4]);
                  g.pers.push(wid + '_' + row[5]);
                  g.spc = g.spc || (row[7] & 2);
               }
            }
            console.log('Grouping', groups);
            data.groups = groups;
         }

         $().ready(function () {
            preprocessData(basketTestdataKH);
            grid = $('#grid').ebtable(opts, basketTestdataKH);
         });
      </script>
   </head>
   <body>
      <div id="grid"></div>
   </body>
</html>
